<script type="text/javascript">
  RED.nodes.registerType("Contract Method", {
    category: "Near Protocol",
    defaults: {
      contract: {
        value: "",
        required: true,
        validate: function (nodeContractId) {
          var node = this;
          const findedContract = RED.nodes
            .filterNodes({ type: "Near Contract" })
            .find((contract) => contract.id === nodeContractId);

          return !!findedContract;
        },
      },
      method: { value: "", required: true },
    },
    inputs: 1,
    outputs: 1,
    icon: "near.png",
    oneditprepare: function () {
      var node = this;
      var scope = node.scope || [];
      console.log({ node });
      var candidateNodes = RED.nodes.filterNodes({ type: "Near Contract" });
      var contractSelector = $("#node-input-contract");
      var methodSelector = $("#node-input-method");

      contractSelector.css("width", "calc(100% - 150px)").typedInput({
        types: [
          {
            value: "contract",
            options: candidateNodes.map((contract) => ({
              value: contract.id,
              label: [contract.contract, "-", contract?.accountId].join(" "),
            })),
          },
        ],
      });

      contractSelector.on("change", function (e) {
        var contractNodeId = $(this).val();
        const findedContract = candidateNodes.find(
          (someContract) => someContract.id === contractNodeId
        );

        methodSelector.empty();
        methodSelector.val(node.method);

        findedContract.methods?.forEach((method) => {
          const newOption = $("<option></option>");
          newOption
            .attr("value", method.name)
            .text(method.type + " " + method.name);
          if (method.name === node.method) newOption.attr("selected", true);
          methodSelector.append(newOption);
        });
      });

      methodSelector.on("change", function (e) {
        node.method = e.target.value;
      });
    },
    label: function () {
      var node = this;
      const selectedContract = RED.nodes
        .filterNodes({ type: "Near Contract" })
        .find((contract) => contract.id === this.contract);

      const method = selectedContract?.methods?.find(
        (method) => method.name === this.method
      );

      if (method?.type && selectedContract?.contract && method?.name)
        return `${method.type} ${selectedContract.contract}.${method.name}( )`;
      else return "Contract Method";
    },
  });
</script>

<script type="text/html" data-template-name="Contract Method">
  <div class="form-row">
    <i class="fa fa-file"></i>
    <label for="node-input-contract"> Contract</label>
    <input type="hidden" id="node-input-contract" placeholder="Contract" />
  </div>

  <div class="form-row">
    <i class="fa fa-wrench"></i>
    <label for="node-input-method"> Method</label>
    <select id="node-input-method"></select>
  </div>
</script>
