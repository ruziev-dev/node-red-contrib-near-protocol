<script type="text/javascript">
  RED.nodes.registerType("Contract Method", {
    category: "Near Protocol",
    defaults: {
      contract: {
        value: "",
        required: true,
        validate: function (nodeContractId) {
          var node = this;
          const findedContract = RED.nodes
            .filterNodes({ z: node.z })
            .find((someContract) => someContract.id === nodeContractId);
          return !!findedContract;
        },
      },
      method: { value: "", required: true },
    },
    inputs: 1,
    outputs: 1,
    icon: "near.png",
    oneditprepare: function () {
      var node = this;
      var scope = node.scope || [];

      var candidateNodes = RED.nodes
        .filterNodes({ z: node.z })
        .filter((node) => node.type === "Near Contract");

      $("#node-input-contract")
        .css("width", "calc(100% - 150px)")
        .typedInput({
          types: [
            {
              value: "contract",
              options: candidateNodes.map((contract) => ({
                value: contract.id,
                label: [contract.contract, "-", contract.accountId].join(" "),
              })),
            },
          ],
        });

      $("#node-input-contract").on("change", function (e) {
        var contractNodeId = $(this).val();
        const findedContract = candidateNodes.find(
          (someContract) => someContract.id === contractNodeId
        );

        console.log({ findedContract });
        /*  var propertyName = $("<input/>", {
          class: "node-input-method",
          type: "text",
        }). */
        $("#node-input-method")
          .css("width", "calc(100% - 150px)")
          .typedInput({
            types: [
              {
                value: "method",
                //TODO: refactor props to methods
                options:
                  findedContract?.props?.map((method) => ({
                    value: method,
                    label: method.v, // TODO: chande to method.name
                  })) || [],
              },
            ],
          });
        $("#node-input-method").on("change", function (e) {
          var method = $(this).val();
          console.log("#node-input-method", method);
        });
        //console.log({ propertyName });
      });
    },
    label: function () {
      return this?.method?.v || "Contract Method";
    },
  });
</script>

<script type="text/html" data-template-name="Contract Method">
  <div class="form-row">
    <i class="fa fa-file"></i>
    <label for="node-input-contract"> Contract</label>
    <input type="hidden" id="node-input-contract" placeholder="Contract" />
  </div>

  <div class="form-row">
    <i class="fa fa-wrench"></i>
    <label for="node-input-method"> Method</label>
    <input type="hidden" id="node-input-method" placeholder="Method" />
  </div>
</script>
